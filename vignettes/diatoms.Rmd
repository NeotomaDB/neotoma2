---
title: "Working with diatom data in the neotoma2 R package"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Working with diatom data in the neotoma2 R package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---
#Introduction and Overview
The ultimate purpose of this document is to provide general guidance and specific code examples for those wanting to use Neotoma R2 to retrieve and work with Neotoma diatom data.  An initial purpose is to help programmers (Simon, Socorro) develop Neotoma2 resources by providing a structured description of how diatom researchers may wish to use N-R2, and specific tasks they may wish to accomplish.

This document is organized to address two main goals of users, to browse the database to identify datasets that meet specified criteria, and to create output files that can be used for further analysis.  Other goals are to create plots and maps and to analyze data using R code.

#Browse data
The browse section includes examples of different ways to find available datasets using a variety of criteria, either alone or in combination.  Criteria include those available in Neotoma Explorer, plus several more. Examples also include options for viewing and saving output results.

#Create data output files 
This section provides examples for retrieving data and creating output files in a few basic formats.  Formats include those that can be used as input to data analysis programs - R packages and others.  generally include all related data - amount of data can be reduced later includes several descriptive variables and is easily readable

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(neotoma2)
library(neotoma)
```

In the chunk to use neotoma::get_site(whatever) when using for Old neotoma package with new one 


One of the main goals of Neotoma is to pull records out of Neotoma into the R workflow.  

### Diatoms

When working with diatoms there is surface and top-bottom and cores
* Pull diatom surface samples.
```{r getDiatoms, eval=FALSE}
neDiatoms <- get_datasets(datasettype="diatom surface samples", loc=BOUNDING BOX)

neDiatoms <- get_datasets(dois=c(...))
```

  * We may want to pull spatially, or pull by "National Assessment", or by other defined calibration set.

 
  
### Water Chemistry 
```{r getWaterChem, eval=FALSE}
neDiatoms <- get_datasets(datasettype="diatom surface samples", loc=BOUNDING BOX)
```
* Look for water chemistry at the same site (or collection unit).

# Browsing 
```{r get__, eval=FALSE}

```
*Creating fill in place for header 

### Diatom Sampling 
Gets data for diatom dataset types general 
``` {r getDiatom, eval=FALSE}
neDiatoms <- get_datasets(datasettype="diatom", loc=BOUNDING BOX)
```


### Surface Sampling 
Gets data for diatom surface sample dataset types
``` {r getDiatomSurf, eval=FALSE}
neDiatoms <- get_datasets(datasettype="diatom surface", loc=BOUNDING BOX)
```

### Top-Bottom Sampling 
``` {r getDiatomTopBot, eval=FALSE}
neDiatoms <- get_datasets(datasettype="diatom top bottom", loc=BOUNDING BOX)
```
Gets data for diatom Top-Bottom dataset types 

###Diatom compiled
Gets all data for the diatom dataset types
``` {r getDiatom, eval=FALSE}
neDiatoms <- get_datasets(datasettype="diatom","diatom top bottom","diatom surface"), loc=BOUNDING BOX)
```

### Chronology
```{r get_, eval=FALSE}

```

# Output

##Diatom taxa list
To get list of taxa in diatom dataset 
```{r get_dataset, eval=FALSE}
diatoms <- get_dataset(datasettype="diatom")
diatom.dl<- get_download(diatoms)
diatom.taxa<- taxa(diatom.dl)
```

## Diatom Counts
To create diatom counts from Neotoma DB sites being a single site 
```{r get_, eval=FALSE}
schrader <- get_site('Schrader Pond')
schrader.data <- get_dataset(schrader)
schrader.dl <- get_download(schrader.data)
schrader.cnt <- counts(schrader.dl)
sapply(schrader.cnt, dim) 
print(schrader.dl)
```

#Examples

## Geolocation
For Northeast example
```{r get_, echo=FALSE}
library(dplyr)
library(purrr)
library(neotoma)

gpids <- c(8412, 7990, 7934, 7326, 7923, 8981, 6442, 7368)
ne_sites <- map(gpids, function(x) get_site(gpid = x)) %>%
bind()
```


Look for a table that explicitly matches water chemistry and diatom datasets, in cases where records have been sampled multiple times.

* In theory collection dates are a good idea to use to filter, but collection dates might not be specific enough.

* In some regional studies water chemistry was sampled multiple times during the summer (e.g.) but diatoms were sampled only a single time.

* Was this going to be done in the aggregate dataset method?  Didn't happen.

Then:
* With one diatom record per water chemistry record
* we need taxon name, we need water chemistry type & units

Then we do some inference modeling (`rioja`).  Building e.g., transfer functions.

* Then run predictions on cores & plot predicted values & error

* We would extract an appendix of publications for the datasets we use.
* We would want some maps of site locations
* We would want some simple scatter plots
* We would want to do something about understanding taxonomic differences (so we'd want to know who the analyst was, or who the PI was)
* We might want to group or synonomize.  Can we pull those from Neotoma?
* We want the stratigraphic diagrams for cores, and surface sample diagrams for surface sample sets
* We want the lists of dataset DOIs.
* Want abundances of taxa along a gradient (with superimposed curves?)
