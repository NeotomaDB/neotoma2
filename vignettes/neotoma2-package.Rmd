---
title: "The neotoma2 R Package"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{The neotoma2 R Package}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(neotoma2)
```

## Neotoma Data Structure

Data in Neotoma is associated with sites, specific locations with lat/long coordinates.  Within a site, there may be one or more **collection units**, which are loactions at which samples are physically collected.  For example, an archaeological **site** may have one or more **collection units**.  These may have higher resolution GPS locations, but are considered to be part of the broader site.  Within a **collection unit** data is collected at various **analysis units** from which **samples** are obtained.

Because Neotoma is made up of a number of constituent databases (e.g., the Indo-Pacific Pollen Database, NANODe), a set of **sample**s associated with a **collection unit** are assigned to a single **dataset** associated with a particular **dataset type** and **constituent database**.

We often begin by searching for sites within our particular study area, whether that is defined by geographic or political boundaries.

### Package Requirements

The `neotoma2` package draws primarily on `dplyr` and `purrr` packages from the `tidyverse`, and on the `sf` spatial data package.

## Site Searches

Sites can be searched using the `get_site()` function, or, can be created using the `set_site()` function. A single `site` object is a special object in R, that can be combined into a `sites` object, effectively a `list()` of `site` objects.

### Finding a site

You can find a site by its unique numeric Neotoma site id (`x`), by name (`sitename`), by altitude (`altmin`, `altmax`), by geopolitical name (`gpid`), or by location (`loc`).

#### Using a Site ID

If we're looking for a site and we know its specific site identifier, we can use the simplest implementation of `get_site()`:

```{r getSitex}
# Wild Tussock Lake has site ID 10101:
wildTussock = get_site(x=10101)
swainSite =  get_site(x=100)
```


## Publications

Many Neotoma records have publications associated with them.  The `publication` object (and the `publications` collection) provide the opportunity to do this.  The [`publication`](http://open.neotomadb.org/dbschema/tables/publications.html) table in Neotoma contains an extensive number of fields.  The methods for `publications` in the `neotoma2` package provide us with tools to retrieve publication data from Neotoma, to set and manipulate publication data locally, and to retrieve publication data from external sources (e.g., using a DOI).

### `get_publications()` from Neotoma

Publications in Neotoma can be discovered using a number of parameters including   

The most simple case is a search for a publication based on one or more publication IDs.  Most people do not know the unique publication ID of individual articles, but this provides a simple method to highlight the way Neotoma retrieves and presents publication information.

#### Get Publication By ID

We can use a signle publication ID or multiple IDs.  In either case the API returns the publication(s) and creates a new `publications` object (which consists of multiple individual `publication`s).  

```{r}
one <- get_publications(12)
two <- get_publications(c(12,14))
```

#### Get Publication using Search:

We can also use search elements to search for publications.  The `get_publication` method uses the Neotoma API to search for publications.  We can search using the following properties:

* `publicationid`
* `datasetid`
* `siteid`
* `familyname`
* `pubtype`
* `year`
* `search`
* `limit`
* `offset`

```{r}
michPubs <- get_publications(search="Michigan", limit=2)
length(michPubs)
```

This results in a set of `r length(michPubs)` publications from Neotoma.  Equal to the `limit` in this case.  If the number of matching publications is less than the limit then the `length()` will be smaller.

By default the `limit` for all queries is `25`.  The default `offset` is `0`.  To capture all results it is possible to add `limit=99999999` or some similarly high number.  **However**, this is hard on the Neotoma servers.  Best practice is to loop through results, using `limit` and `offset`, for example, in a `while` loop.  In a result set of 100 records, the `limit`, when `offset` is 0 (the default), ensures that only the first 25 records are returned.  Keeping the `limit` at 25, and increasing the `offset` to 25 would give us the next 25 records.

We can use that in a `while` loop in R in the following way:

```{r}
run = TRUE
offset <- 0

while(run) {
  newPubs <- get_publications(search="Michigan", offset=offset)
  if(length(newPubs) == 0) {
    run = FALSE
  }
  if(exists('allPubs')) {
    allPubs <- c(allPubs, newPubs)
  } else {
    allPubs <- newPubs
  }
  offset <- offset + 25
}
```

This gives us an object of length `r length(allPubs)`, the number of publications in Neotoma that reference Michigan.



We can see a summary of the returned object by simply calling it:

```{r}
one
```

This returns the (Neotoma) ID, the citation and the publication DOI (if that is stored in Neotoma).  We can get the first publication using the standard `[[` nomenclature:

```{r}
two[[1]]
```

The output will look similar to the output for `two` above, however you will see that only a single result will be returned.  We can also select an array of objects using this method, either as a sequence (`1:10`, or as a numeric vector (`c(1,2,3)`)):

```{r}
pubArray <- get_publications(1:10)
subPub <- pubArray[[1:5]]
```

## Workflows

One of the main goals of Neotoma is to pull records out of Neotoma into the R workflow.  

### Diatoms

```{r getDiatoms, eval=FALSE}
neDiatoms <- get_datasets(datasettype="diatom surface samples", loc=BOUNDING BOX)

neDiatoms <- get_datasets(dois=c(...))
```

* Pull diatom surface samples.
  * We may want to pull spatially, or pull by "National Assessment", or by other defined calibration set.

```{r getWaterChem, eval=FALSE}
neDiatoms <- get_datasets(datasettype="diatom surface samples", loc=BOUNDING BOX)
```

* Look for water chemistry at the same site (or collection unit).

Look for a table that explicitly matches water chemistry and diatom datasets, in cases where records have been sampled multiple times.

* In theory collection dates are a good idea to use to filter, but collection dates might not be specific enough.

* In some regional studies water chemistry was sampled multiple times during the summer (e.g.) but diatoms were sampled only a single time.

* Was this going to be done in the aggregate dataset method?  Didn't happen.

Then:
* With one diatom record per water chemistry record
* we need taxon name, we need water chemistry type & units

Then we do some inference modeling (`rioja`).  Building e.g., transfer functions.

* Then run predictions on cores & plot predicted values & error

* We would extract an appendix of publications for the datasets we use.
* We would want some maps of site locations
* We would want some simple scatter plots
* We would want to do something about understanding taxonomic differences (so we'd want to know who the analyst was, or who the PI was)
* We might want to group or synonomize.  Can we pull those from Neotoma?
* We want the stratigraphic diagrams for cores, and surface sample diagrams for surface sample sets
* We want the lists of dataset DOIs.
* Want abundances of taxa along a gradient (with superimposed curves?)
