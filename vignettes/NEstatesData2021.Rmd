---
title: "NE-Dtm-Collab"
author: "Don Charles"
date: "11/18/2021"
output: html_document
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup}
library(neotoma2)
library(neotoma)
library(dplyr)
library(purrr)
library(sf)
```

```{r setup1, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The purpose of this document is to document R code procedures for
examining and creating output files to meet goals of the Northeast Lake
Sediment Diatom Collaborative. Much basic code was copied from
diatoms.Rmd

Get site and dataset data from Northeast states using state gpids

```{r retrieveNEdatasets}

# Get site data for all sites in all New England states (ME, VT, NH, CT, MA, RI) plus NJ and NY
# The gpids were obtained from the Geopolitical units table 

gpids <- c(8412, 7990, 7934, 7326, 7923, 8981, 6442, 7368)
ne_sites <- map(gpids, function(x)
  neotoma:::get_site(gpid = x)) %>%
  neotoma::bind()
ne_datasets <- get_datasets(ne_sites)
saveRDS (ne_datasets, file = "ne_datasets")
ne_datasets
```

```{r downloadNEdatasetsl}
ne_down_dtsts <- neotoma::get_download(ne_datasets)
ne_down_dtsts 
ne_datasetids <-sapply(ne_down_dtsts, 
                 function(x) {               c(x$dataset$site.data$site.id, x$dataset$site.data$site.name, x$dataset$dataset.meta$dataset.id, x$dataset$dataset.meta$dataset.name,  x$dataset$dataset.meta$dataset.type, x[[6]][2][4])
                   })
ne_datasetids
saveRDS (ne_datasetids, "ne_datasetids")
#ne_down_sites <- neotoma::get_download(ne_sites)
# The code will run get_site for each gpid, then will bind the results, and then downloaded data
```

Run get_download for all sites in the northeast US to create a download
file and then run get_chroncontrol to extract the chronology data.

```{R NE_ExtractChroncontrol}
# Get chroncontrol data from download file
ne_chroncontrol <- get_chroncontrol(ne_down_dtsts, chronology = 1, verbose = TRUE, add = FALSE)
saveRDS (ne_chroncontrol, "ne_chroncontrol")
```

```{R ChronMetadata}
# Get chronology .meta data from chroncontrol file
ne_chron_meta <- sapply (ne_chroncontrol,
                         function(x) {x[2]
                           })
ne_chron_met <- do.call(rbind,ne_chron_meta)
#Get .parent data from chroncontrol file
ne_chron_parent <- sapply (ne_chroncontrol,
                         function(x) {x[4]
                           })
ne_chron_parent <- do.call(rbind,ne_chron_parent)
# Combine .meta and .parent files
ne_chron_metandpar <- cbind(ne_chron_parent, ne_chron_met)
ne_chron_noNAnoCD <- filter(ne_chron_metandpar, name != "Collection date", !is.na(name))
saveRDS (ne_chron_noNAnoCD, "ne_chron_noNAnoCD")
WriteXLS::WriteXLS(ne_chron_noNAnoCD, "ne_chron_noNAnoCD.xls")
```

#ne_chronmeta \<-sapply (ne_chroncontrol, \# function(x) {
c(x$meta$name, x$meta$chron.id, x$meta$age.type, x$parent$dataset.name,
x$parent$dataset.id, x$parent$dataset.type) }) #ne_chronmeta
#str(ne_chronmeta) #select (ne_chronmeta, x$meta$chron.id )
as.data.frame (ne_chronmeta) str(ne_chronmeta) attributes (ne_chronmeta)
#transpose(ne_chronmeta) write(ne_chronmeta) #view (ne_chronmeta) \`\`\`


```{r percent abundance function}
pc_abun <- function(dl_object) {
  samp <- samples(dl_object)
  taxa <- samp$variablename
  count <- samp$value
  sampleid <- samp$sampleid
  countDF <- data.frame(sampleid, taxa, count) %>%
    group_by(sampleid) %>%
    mutate(count_pct = count*100 / sum(count))
  return(countDF)
}
```

```{r geo pol (state) function}
geopol_form <- function(x) {
                allids <- getids(x)
                siteids <- unique(allids$siteid)
                return(siteids)
}

##USE OUTPUT FROM ABOVE FUNCTION INTO NEXT FUNCTION
##example: y <- geopol_form(x)
########## geopol(y)

geopol <- function(x) {
            states <- purrr::map(x, function(y) {
                                      site <- get_sites(y)
                                      dls <- get_downloads(site)
                                      dls[[1]]@geopolitical[[1]][[2]]
                                      })
            as.data.frame(x,(unlist(states))) %>%
            rename(siteid = x) %>%
            print()
}
```

```{r combine geopol() & samples()  function}
#function to add states to samples output dataframe
# x = geopol() output
# y = samples() output (or any dataframe with siteid)
sampdf <- function(x,y) {
x$states <- row.names(x)
  merge(y, x, by = 'siteid')
}
```

#mapping

```{R siteSpatialSearch}
northeastUS <- rbind(c(-80,40), c(-80,48),
                     c(-65,48), c(-65,40), c(-80,40))
neus <- sf::st_polygon(list(northeastUS))

#As the deafault, `get_datasets()` only retrieves the first 25 results. Use the argument `limit =" to change this.
neUSsites <- get_datasets(datasettype = "diatom surface sample", loc = neus, limit = 299)

neUSsites2 <- get_datasets(datasettype = "diatom surface sample", loc = neus, limit = 299, offset = 300)

neUSsites3 <- get_datasets(datasettype = "diatom surface sample", loc = neus, limit = 299, offset = 599)

neUSsites4 <- get_datasets(datasettype = "diatom surface sample", loc = neus, limit = 299, offset = 898)

plotLeaflet(neUSsites)
``` 

```{R MasterListTaxa, eval=FALSE}
#code taken from `get_table()` documentation
#doesn't seem to work
someTaxa <- get_table('taxa')
# Loop with the offset to get all specimens:
okay <- TRUE
counter <- 1
taxa <- list()
while(okay) {
  taxa[[counter]] <- get_table('taxa', offset = (counter - 1) * 25)
  if(nrow(taxa[[counter]]) < 25) {
    okay <- FALSE
  } else {
    counter <- counter + 1
  }
}
taxa <- taxa %>% dplyr::bind_rows()
```
